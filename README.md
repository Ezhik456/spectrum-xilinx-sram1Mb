# spectrum-xilinx-sram1Mb
zx spectrum128 fpga xilinx

продолжаю заниматься странными вещами. я же хочу звук и все такое. а для звука нужна память. а память кончилась.  

ок цепляем SDRAM. И тут начинаются сложности. память отдает байт данных за 6 тактов - установка RAS, установка команды и CAS, 2 такта latency. и 100мгц моей памяти превращаются в тыкву. оно не может отдавать данные процессору и видеоконтроллеру одновременно.  

посмотрим как люди делают. а люди используют блочную память для двух страниц видеопамяти, а все остальное мапят уже из внешней памяти.  

16кб - ПЗУ, одна страничка, ибо там два бейсика и TRDOS  
16кб - две страницы видеопамяти - блок5 и блок7  
16кб - всегда блок2  
16кб - блоки от 0 до 7, сюда оно и подставляется для 128кб версии. причем блоки 5 и 7 у меня из блочной памяти, необходимо это разрулить в мультиплексоре.  

    assign cpu_d_bus =
    [..]
    // read xC000, bank5
    ( mem_rd && cpu_a_bus[15:14] == 2'b11 
    && port_7ffd[7:5] == 3'b000 && port_7ffd[2:0] == 5) ? video_rd_data_cpu :
    // read xC000, bank7
    ( mem_rd && cpu_a_bus[15:14] == 2'b11 
    && port_7ffd[7:5] == 3'b000 && port_7ffd[2:0] == 7) ? video_rd_data_cpu :
    // read xC000, sram
    ( mem_rd && cpu_a_bus[15:14] == 2'b11 ) ? SRAM_D :

рулится все это добро битами регистра 7ffd.  

ок. цепляем SDRAM корку из одного открытого проекта. разруливаем доступ по страничкам. начинает проходить тест памяти. и даже какие-то игрушки работают. но нестабильно. и регулярно лезут ошибки зацикленного теста памяти.  

тест использовал от "Alexander Kormishin Тест-ПЗУ 2.3". и он постоянно падал на зацикленном тесте. а еще он как-то странно ее тестировал. лезли глюки на картинку.  

после ожесточенной битвы я решил - хватит разврата и отключил SDRAM. быстренько напаял на монтажку два чипа статической памяти по полмегабайта. ноги CS развел на разные ножки ФПГА.  

зацикленный тест памяти провалился. я решил его выкинуть к черту, ибо остальные тесты работали часами без ошибок.  

щаг следующий. а откуда будем грузиться? 48кб с пленки - это 5 минут ожидания. 128кб - 10 минут. ДА НУ ЕГО НАФИГ!  

цепляем divMMC. ему надо 512кб памяти, их у меня есть. разруливаем порты, регистры, доступ к карточке.  

образ занимает нижние 8кб адресного пространства. в следующие 8кб мапятся 64 страницы его памяти. туда грузится всякое рабочее добро.  

    assign SRAM_A = 
    // divmmc ESXDOS RAM 2000-3FFF
    ( (CONMEM || AUTOMAP) & cpu_a_bus[15:13] == 1'b001 ) ? { port_e3[5:0], cpu_a_bus[12:0] } :
    // x8000 aka Bank2
    ( cpu_a_bus[15:14] == 2'b10 ) ? {2'b00 , 3'b010, cpu_a_bus[13:0]} :
    // Bank5 - from video memory
    // Bank7 - from video memory
    // xC000
    //( cpu_a_bus[15:14] == 2'b11 ) ? 
    //{2'b00, port_7ffd[2:0], cpu_a_bus[13:0]} ;	// 128k ver
    {port_7ffd[6:5], port_7ffd[2:0], cpu_a_bus[13:0]} ;	// 512kb ver

вызов этого образа происходит при старте процессора, грузятся необходимые kernel модули с карточки и отдается управление basic48. попутно навешивается обработчик NMI. в DivGMX откуда я таскал корки, расширенный режим вызывается отдельной кнопкой, решил сделать так же.  

после того как начали грузиться TAP и TRD образы и стали проходить успешно тесты я прикрутил звук. корка заработала сразу. теперь надо вывести с нее звук. но добрые китайцы напихали в плату все, что могли. и прицепили аудиоЦАП на те же ноги, что и VGA. утырки.  

пришлось прикрутить дельта-сигма ЦАП. оно запело сразу и красиво. но я не теряю надежды, у меня в закромах лежит монтажка с аудиокодеком, надо ее повесить на свободные ножки.  

еще надо попытаться снова запустить SDRAM. 32 мегабайта - это 32 мегабайта.  

еще мне понравилось как в DivGMX происходит загрузка образов ПЗУ. при старте читается SPI флэшка, часть верхней ОЗУ заполняется образами, и по желанию они переключаются. саму флэшку я могу пропустить насквозь и шить через программатор CH341.  

осталось понять почему из демок работают одна из сотни. где-то у меня несовместимость.  
